<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Blockly Music demo</title>
<script src="../../blockly_uncompressed.js"></script>
<script src="../../generators/javascript.js"></script>
<script src="../../generators/javascript/logic.js"></script>
<script src="../../generators/javascript/loops.js"></script>
<script src="../../generators/javascript/math.js"></script>
<script src="../../generators/javascript/text.js"></script>
<script src="../../generators/javascript/lists.js"></script>
<script src="../../generators/javascript/music.js"></script>
<script src="../../generators/javascript/variables.js"></script>
<script src="../../generators/javascript/procedures.js"></script>
<script src="../../msg/messages.js"></script>
<script src="../../blocks/logic.js"></script>
<script src="../../blocks/loops.js"></script>
<script src="../../blocks/math.js"></script>
<script src="../../blocks/text.js"></script>
<script src="../../blocks/lists.js"></script>
<script src="../../blocks/music.js"></script>
<script src="../../blocks/variables.js"></script>
<script src="../../blocks/procedures.js"></script>

<!-- Libraries for MIDI playback. -->
<script src="../../../MIDI.js/build/MIDI.js"></script>
<script src="../../../MIDI.js/inc/shim/Base64binary.js"></script>
<script src="./music_player.js"></script>

<script>
  'use strict';

  // Depending on the URL argument, render as LTR or RTL.
  var rtl = (document.location.search == '?rtl');
  var workspace = null;
  var musicPlayer = null;
  var activeTimeouts = [];

  function start() {
    var toolbox = document.getElementById('toolbox');
    workspace = Blockly.inject('blocklyDiv', {
      collapse: true,
      comments: true,
      disable: true,
      grid: {
        colour: '#ccc',
        length: 3,
        snap: true,
        spacing: 25
      },
      maxBlocks: Infinity,
      media: '../../media/',
      readOnly: false,
      rtl: rtl,
      scrollbars: true,
      toolbox: toolbox,
      zoom: {
        controls: true,
        maxScale: 4,
        minScale: .25,
        scaleSpeed: 1.1,
        startScale: 1.0,
        wheel: true
      }
    });

    // Decrease the hover time for tooltips.
    Blockly.Tooltip.HOVER_MS = 150;

    // Add a 'start hat' for event blocks.
    Blockly.BlockSvg.START_HAT = true;

    var defaultBlocks = document.getElementById('blocklyDefault');
    Blockly.Xml.domToWorkspace(workspace, defaultBlocks);

    musicPlayer = new MusicPlayer();

    // Load the first challenge after the page has loaded.
    setTimeout(function() {
      setChallenge('tutorial', 1);
    });
  }

  // The code generated by the blocks calls this function.
  function addChord(pitches, durationInBeats) {
    musicPlayer.addPlayerChord(pitches, durationInBeats);
  }

  function toCode(lang) {
    var output = document.getElementById('importExport');
    output.value = Blockly[lang].workspaceToCode(workspace);
  }

  var MELODIES = [[
    [null, 0.125],
    [[64], 0.125],
    [[67], 0.125],
    [[64], 0.125],
    [[67], 0.125],
    [[60], 0.5],
    [[64], 0.125],
    [[67], 0.125],
    [[64], 0.125],
    [[67], 0.625],
    [[64], 0.125],
    [[67], 0.125],
    [[64], 0.125],
    [[67], 0.125],
    [[60], 0.5],
    [[64], 0.125],
    [[67], 0.125],
    [[64], 0.125],
    [[67], 0.5]
  ], [
    [[67], 0.75],
    [[64], 0.25],
    [[62], 0.5],
    [[67], 0.25],
    [[64], 0.75],
    [[60], 0.25],
    [[57], 1.25]
  ]];

  var CHALLENGES_TUTORIAL = [{
    htmlInstructions: 'Play a single note, C3.',
    expectedLine: [
      [[36], 1]
    ],
    beatsPerMinute: 80,
    accompaniment: null
  }, {
    htmlInstructions: 'Modify the note to become E3 instead.',
    expectedLine: [
      [[40], 1]
    ],
    beatsPerMinute: 80,
    accompaniment: null
  }, {
    htmlInstructions: 'Play the sequence G3-A3-F3 in order.',
    expectedLine: [
      [[43], 1],
      [[45], 1],
      [[41], 1]
    ],
    beatsPerMinute: 80,
    accompaniment: null
  }, {
    htmlInstructions: 'Play the chord C3-E3-G3.',
    expectedLine: [
      [[36, 40, 43], 1]
    ],
    beatsPerMinute: 80,
    accompaniment: null
  }, {
    htmlInstructions: 'Play the chord C3-F3-A3, then the chord C3-E3-G3.',
    expectedLine: [
      [[36, 41, 45], 1],
      [[36, 40, 43], 1]
    ],
    beatsPerMinute: 80,
    accompaniment: null
  }];

  var CHALLENGES_BEGINNER = [{
    htmlInstructions: 'Play Mary Had a Little Lamb: E4-D4-C4-D4-E4-E4-E4. Try to use only six blocks.',
    expectedLine: [
      [[52], 1],
      [[50], 1],
      [[48], 1],
      [[50], 1],
      [[52], 1],
      [[52], 1],
      [[52], 1]
    ],
    beatsPerMinute: 100,
    accompaniment: null
  }, {
    htmlInstructions: 'Play Can You Feel the Love Tonight: G4--E4D4-G4E4--C4A3----',
    expectedLine: [
      [[55], 3],
      [[52], 1],
      [[50], 2],
      [[55], 1],
      [[52], 3],
      [[48], 1],
      [[45], 4]
    ],
    beatsPerMinute: 120,
    accompaniment: null
  }, {
    htmlInstructions: 'Play The Entertainer: D4E4C4A3-B3G3',
    expectedLine: [
      [[50], 0.5],
      [[52], 0.5],
      [[48], 0.5],
      [[45], 1],
      [[47], 0.5],
      [[43], 0.5]
    ],
    beatsPerMinute: 80,
    accompaniment: null
  }, {
    htmlInstructions: 'Play Happy Birthday: G3..G3 A3 G3 C4 B3 - G3..G3 A3 G3 D4 C4 -',
    expectedLine: [
      [[43], 0.75],
      [[43], 0.25],
      [[45], 1],
      [[43], 1],
      [[48], 1],
      [[47], 2],
      [[43], 0.75],
      [[43], 0.25],
      [[45], 1],
      [[43], 1],
      [[50], 1],
      [[48], 2]
    ],
    beatsPerMinute: 100,
    accompaniment: null
  }, {
    htmlInstructions: 'Mary Had a Little Lamb: Play the chord C3-E3-G3 seven times. Use only two blocks!',
    expectedLine: [
      [[36, 41, 45], 1],
      [[36, 41, 45], 1],
      [[36, 41, 45], 1],
      [[36, 41, 45], 1],
      [[36, 41, 45], 1],
      [[36, 41, 45], 1],
      [[36, 41, 45], 1]
    ],
    beatsPerMinute: 100,
    accompaniment: [
      [[52], 1],
      [[50], 1],
      [[48], 1],
      [[50], 1],
      [[52], 1],
      [[52], 1],
      [[52], 1]
    ]
  }, {
    htmlInstructions: 'Lion King: Play C4 then G3 then A3 then F3. Make each note 4 beats long.',
    expectedLine: [
      [[48], 4],
      [[43], 4],
      [[45], 4],
      [[41], 4]
    ],
    beatsPerMinute: 120,
    accompaniment: [
      [[67], 3],
      [[64], 1],
      [[62], 2],
      [[67], 1],
      [[64], 3],
      [[60], 1],
      [[57], 4]
    ]
  }, {
    htmlInstructions: 'Lion King (reprise): Play C4 for 2 beats then G4 for 2 beats; repeat for the other three.',
    expectedLine: [
      [[48], 2],
      [[55], 2],
      [[43], 2],
      [[50], 2],
      [[45], 2],
      [[52], 2],
      [[41], 2],
      [[48], 2],
    ],
    beatsPerMinute: 120,
    accompaniment: [
      [[67], 3],
      [[64], 1],
      [[62], 2],
      [[67], 1],
      [[64], 3],
      [[60], 1],
      [[57], 4]
    ]
  }, {
    htmlInstructions: 'Edelweiss: Play C4 - E4/G4 - E4/G4 (1 beat each), ditto for the other three.',
    expectedLine: [
      [[48], 1],
      [[52, 55], 1],
      [[52, 55], 1],
      [[43], 1],
      [[47, 50], 1],
      [[47, 50], 1],
      [[45], 1],
      [[49, 52], 1],
      [[49, 52], 1],
      [[41], 1],
      [[45, 48], 1],
      [[45, 48], 1]
    ],
    beatsPerMinute: 120,
    accompaniment: [
      [[64], 2],
      [[67], 1],
      [[74], 3],
      [[72], 2],
      [[67], 1],
      [[65], 3]
    ]
  }, {
    htmlInstructions: 'Frozen: Play C4/E4-G4 four times quickly (half-beat each) then B3/D4-G4 then A3/C4-E4 then A3/C4-F4.',
    expectedLine: [
      [[60, 64], 0.5],
      [[55], 0.5],
      [[60, 64], 0.5],
      [[55], 0.5],
      [[60, 64], 0.5],
      [[55], 0.5],
      [[60, 64], 0.5],
      [[55], 0.5],

      [[59, 62], 0.5],
      [[55], 0.5],
      [[59, 62], 0.5],
      [[55], 0.5],
      [[59, 62], 0.5],
      [[55], 0.5],
      [[59, 62], 0.5],
      [[55], 0.5],

      [[57, 60], 0.5],
      [[52], 0.5],
      [[57, 60], 0.5],
      [[52], 0.5],
      [[57, 60], 0.5],
      [[52], 0.5],
      [[57, 60], 0.5],
      [[52], 0.5],

      [[57, 60], 0.5],
      [[53], 0.5],
      [[57, 60], 0.5],
      [[53], 0.5],
      [[57, 60], 0.5],
      [[53], 0.5],
      [[57, 60], 0.5],
      [[53], 0.5]
    ],
    beatsPerMinute: 140,
    accompaniment: [
      [[72], 2.5],
      [[67], 0.5],
      [[76], 0.5],
      [[74], 3.5],
      [[72], 1],
      [[69], 1],
      [[69], 0.5],
      [[69], 0.5],
      [[69], 0.5],
      [[71], 1],
      [[72], 1],
      [[74], 0.5],
      [[72], 3]
    ]
  }, {
    htmlInstructions: 'Play anything you like.',
    expectedLine: null,
    beatsPerMinute: 120,
    accompaniment: null
  }];

  var CHALLENGES_ADVANCED = [];

  var CHALLENGE_SUITES = {
    tutorial: CHALLENGES_TUTORIAL,
    beginner: CHALLENGES_BEGINNER,
    advanced: CHALLENGES_ADVANCED
  };

  var currentChallengeSuite = CHALLENGE_SUITES.tutorial;
  var currentChallengeIndex = 0;

  function setChallenge(suiteName, challengeNumber) {
    currentChallengeSuite = CHALLENGE_SUITES[suiteName];
    currentChallengeIndex = challengeNumber - 1;
    document.getElementById('instructions').textContent =
        currentChallengeSuite[currentChallengeIndex].htmlInstructions;

    document.getElementById('playWithAccompanimentButton').style.display =
      currentChallengeSuite[currentChallengeIndex].accompaniment ?
      null : 'none';
  }

  function gradeChallenge() {
    if (!expectedLine) {
      document.getElementById('grade').textContent = 'Nice tune!';
      return;
    }

    var expectedLine = new MusicLine();
    expectedLine.setFromChordsAndDurations(
      currentChallengeSuite[currentChallengeIndex].expectedLine);

    document.getElementById('grade').textContent =
        musicPlayer.doesPlayerLineEqual(expectedLine) ?
        'Correct!' : 'Incorrect.';
  }

  function resetGradeAndPlayer() {
    document.getElementById('grade').textContent = '';
    musicPlayer.reset();
  }

  function playAndGrade() {
    resetGradeAndPlayer();

    runCodeToPopulatePlayerLine();
    musicPlayer.playPlayerLine(
        currentChallengeSuite[currentChallengeIndex].beatsPerMinute,
        gradeChallenge);
  }

  function playWithAccompanimentAndGrade() {
    resetGradeAndPlayer();

    musicPlayer.setAccompaniment(
        currentChallengeSuite[currentChallengeIndex].accompaniment);
    runCodeToPopulatePlayerLine();
    musicPlayer.playAllLines(
        currentChallengeSuite[currentChallengeIndex].beatsPerMinute,
        gradeChallenge);
  }

  function runCodeToPopulatePlayerLine() {
    // Generate JavaScript code and run it.
    window.LoopTrap = 1000;
    Blockly.JavaScript.INFINITE_LOOP_TRAP =
        'if (--window.LoopTrap == 0) throw "Infinite loop.";\n';

    var code = Blockly.JavaScript.workspaceToCode(workspace);
    Blockly.JavaScript.INFINITE_LOOP_TRAP = null;

    try {
      eval(code);
    } catch (e) {
      alert(e);
    }
  }
</script>

<style>
html, body {
  height: 100%;
}
body {
  background-color: #fff;
  font-family: sans-serif;
  overflow: hidden;
}
h1 {
  font-weight: normal;
  font-size: 140%;
}
#blocklyDiv {
  float: right;
  height: 95%;
  width: 70%;
}
#collaborators {
  float: right;
  width: 30px;
  margin-left: 10px;
}
#collaborators > img {
  margin-right: 5px;
  height: 30px;
  padding-bottom: 5px;
  width: 30px;
  border-radius: 3px;
}
#importExport {
  font-family: monospace;
}
</style>
</head>
<body onload="start()">

  <div id="collaborators"></div>

  <div id="blocklyDiv"></div>

  <xml id="blocklyDefault">
  </xml>

  <xml id="toolbox" style="display: none">
    <category name="Music" colour="20">
      <block type="music_play_note"></block>
      <block type="music_play_note_with_duration"></block>

      <block type="music_play_chord"></block>
    </category>

    <category name="Loops" colour="120">
      <block type="controls_repeat_ext">
        <value name="TIMES">
          <shadow type="math_number">
            <field name="NUM">10</field>
          </shadow>
        </value>
      </block>
      <block type="controls_whileUntil"></block>
      <block type="controls_for">
        <value name="FROM">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
        <value name="TO">
          <shadow type="math_number">
            <field name="NUM">10</field>
          </shadow>
        </value>
        <value name="BY">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
      </block>
      <block type="controls_forEach"></block>
      <block type="controls_flow_statements"></block>
    </category>

    <sep></sep>

    <category name="Functions" colour="290" custom="PROCEDURE"></category>

    <category name="Logic" colour="210">
      <block type="controls_if"></block>
      <block type="logic_compare"></block>
      <block type="logic_operation"></block>
      <block type="logic_negate"></block>
      <block type="logic_boolean"></block>
      <block type="logic_ternary"></block>
    </category>

    <category name="Math" colour="230">
      <block type="math_number" gap="32"></block>
      <block type="math_arithmetic">
        <value name="A">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
        <value name="B">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
      </block>
      <block type="math_single">
        <value name="NUM">
          <shadow type="math_number">
            <field name="NUM">9</field>
          </shadow>
        </value>
      </block>
      <block type="math_trig">
        <value name="NUM">
          <shadow type="math_number">
            <field name="NUM">45</field>
          </shadow>
        </value>
      </block>
      <block type="math_constant"></block>
      <block type="math_number_property">
        <value name="NUMBER_TO_CHECK">
          <shadow type="math_number">
            <field name="NUM">0</field>
          </shadow>
        </value>
      </block>
      <block type="math_change">
        <value name="DELTA">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
      </block>
      <block type="math_round">
        <value name="NUM">
          <shadow type="math_number">
            <field name="NUM">3.1</field>
          </shadow>
        </value>
      </block>
      <block type="math_on_list"></block>
      <block type="math_modulo">
        <value name="DIVIDEND">
          <shadow type="math_number">
            <field name="NUM">64</field>
          </shadow>
        </value>
        <value name="DIVISOR">
          <shadow type="math_number">
            <field name="NUM">10</field>
          </shadow>
        </value>
      </block>
      <block type="math_constrain">
        <value name="VALUE">
          <shadow type="math_number">
            <field name="NUM">50</field>
          </shadow>
        </value>
        <value name="LOW">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
        <value name="HIGH">
          <shadow type="math_number">
            <field name="NUM">100</field>
          </shadow>
        </value>
      </block>
      <block type="math_random_int">
        <value name="FROM">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
        <value name="TO">
          <shadow type="math_number">
            <field name="NUM">100</field>
          </shadow>
        </value>
      </block>
      <block type="math_random_float"></block>
    </category>
  </xml>

  <h1>Blockly Music Demo</h1>

  <p>
    <strong>Tutorial:</strong>
    <a href="#" onclick="setChallenge('tutorial', 1); return false;">1</a>
    <a href="#" onclick="setChallenge('tutorial', 2); return false;">2</a>
    <a href="#" onclick="setChallenge('tutorial', 3); return false;">3</a>
    <a href="#" onclick="setChallenge('tutorial', 4); return false;">4</a>
    <a href="#" onclick="setChallenge('tutorial', 5); return false;">5</a>

    <strong>Beginner:</strong>
    <a href="#" onclick="setChallenge('beginner', 1); return false;">1</a>
    <a href="#" onclick="setChallenge('beginner', 2); return false;">2</a>
    <a href="#" onclick="setChallenge('beginner', 3); return false;">3</a>
    <a href="#" onclick="setChallenge('beginner', 4); return false;">4</a>
    <a href="#" onclick="setChallenge('beginner', 5); return false;">5</a>
    <a href="#" onclick="setChallenge('beginner', 6); return false;">6</a>
    <a href="#" onclick="setChallenge('beginner', 7); return false;">7</a>
    <a href="#" onclick="setChallenge('beginner', 8); return false;">8</a>
    <a href="#" onclick="setChallenge('beginner', 9); return false;">9</a>
    <a href="#" onclick="setChallenge('beginner', 10); return false;">10</a>
  </p>

  <p>
    <div id="instructions">
    </div>
  </p>

  <p>
    <input type="button" value="Run" onclick="playAndGrade();">
    <input type="button" id="playWithAccompanimentButton" value="Run with accompaniment" onclick="playWithAccompanimentAndGrade();">
    <span id="grade"></span>
  </p>

  <p>
    <input type="button" value="View JavaScript code" onclick="toCode('JavaScript')">
    <br><br>
    <textarea id="importExport" style="width: 26%; height: 12em"></textarea>
  </p>
</body>
</html>
