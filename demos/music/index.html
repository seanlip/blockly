<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Blockly Music demo</title>
<script src="../../blockly_uncompressed.js"></script>
<script src="../../generators/javascript.js"></script>
<script src="../../generators/javascript/music.js"></script>
<script src="../../generators/javascript/loops.js"></script>
<script src="../../generators/javascript/procedures.js"></script>
<script src="../../generators/javascript/logic.js"></script>
<script src="../../generators/javascript/math.js"></script>
<script src="../../msg/messages.js"></script>
<script src="../../blocks/music.js"></script>
<script src="../../blocks/loops.js"></script>
<script src="../../blocks/procedures.js"></script>
<script src="../../blocks/logic.js"></script>
<script src="../../blocks/math.js"></script>

<!-- Libraries for MIDI playback. -->
<script src="../../../MIDI.js/build/MIDI.js"></script>
<script src="../../../MIDI.js/inc/shim/Base64binary.js"></script>

<!-- Libraries for music demo. -->
<script src="./music_player.js"></script>
<script src="./levels.js"></script>

<script>
  'use strict';

  // Depending on the URL argument, render as LTR or RTL.
  var rtl = (document.location.search == '?rtl');
  var workspace = null;
  var musicPlayer = null;

  function start() {
    var toolbox = document.getElementById('toolbox');
    workspace = Blockly.inject('blocklyDiv', {
      collapse: true,
      comments: true,
      disable: true,
      grid: {
        colour: '#ccc',
        length: 3,
        snap: true,
        spacing: 25
      },
      maxBlocks: Infinity,
      media: '../../media/',
      readOnly: false,
      rtl: rtl,
      scrollbars: true,
      toolbox: toolbox,
      zoom: {
        controls: true,
        maxScale: 4,
        minScale: .25,
        scaleSpeed: 1.1,
        startScale: 1.0,
        wheel: true
      }
    });

    // Decrease the hover time for tooltips.
    Blockly.Tooltip.HOVER_MS = 150;

    var defaultBlocks = document.getElementById('blocklyDefault');
    Blockly.Xml.domToWorkspace(workspace, defaultBlocks);

    musicPlayer = new MusicPlayer();

    // Load the first challenge after the page has loaded.
    setTimeout(function() {
      setChallenge(LEVELS[0].name, 1);
    });
  }

  // The code generated by the blocks calls this function.
  function addChord(pitches, durationInBeats) {
    musicPlayer.addPlayerChord(pitches, durationInBeats);
  }

  function toCode(lang) {
    var output = document.getElementById('importExport');
    output.value = Blockly[lang].workspaceToCode(workspace);
  }

  var CHALLENGE_SUITES = {
    tutorial: LEVELS[0].levelSet,
    beginner: LEVELS[1].levelSet
  };

  var currentChallengeSuite = CHALLENGE_SUITES.tutorial;
  var currentChallengeIndex = 0;

  function setChallenge(suiteName, challengeNumber) {
    currentChallengeSuite = CHALLENGE_SUITES[suiteName];
    currentChallengeIndex = challengeNumber - 1;
    document.getElementById('instructions').textContent =
        currentChallengeSuite[currentChallengeIndex].htmlInstructions;

    document.getElementById('playWithAccompanimentButton').style.display =
      currentChallengeSuite[currentChallengeIndex].accompaniment ?
      null : 'none';
  }

  function gradeChallenge() {
    if (!expectedLine) {
      document.getElementById('grade').textContent = 'Nice tune!';
      return;
    }

    var expectedLine = new MusicLine();
    expectedLine.setFromChordsAndDurations(
      currentChallengeSuite[currentChallengeIndex].expectedLine);

    document.getElementById('grade').textContent =
        musicPlayer.doesPlayerLineEqual(expectedLine) ?
        'Correct!' : 'Incorrect.';
  }

  function resetGradeAndPlayer() {
    document.getElementById('grade').textContent = '';
    musicPlayer.reset();
  }

  function playAndGrade() {
    resetGradeAndPlayer();

    runCodeToPopulatePlayerLine();
    musicPlayer.playPlayerLine(
        currentChallengeSuite[currentChallengeIndex].beatsPerMinute,
        gradeChallenge);
  }

  function playWithAccompanimentAndGrade() {
    resetGradeAndPlayer();

    musicPlayer.setAccompaniment(
        currentChallengeSuite[currentChallengeIndex].accompaniment);
    runCodeToPopulatePlayerLine();
    musicPlayer.playAllLines(
        currentChallengeSuite[currentChallengeIndex].beatsPerMinute,
        gradeChallenge);
  }

  function runCodeToPopulatePlayerLine() {
    // Generate JavaScript code and run it.
    window.LoopTrap = 1000;
    Blockly.JavaScript.INFINITE_LOOP_TRAP =
        'if (--window.LoopTrap == 0) throw "Infinite loop.";\n';

    var code = Blockly.JavaScript.workspaceToCode(workspace);
    Blockly.JavaScript.INFINITE_LOOP_TRAP = null;

    try {
      eval(code);
    } catch (e) {
      alert(e);
    }
  }
</script>

<style>
html, body {
  height: 100%;
}
body {
  background-color: #fff;
  font-family: sans-serif;
  overflow: hidden;
}
h1 {
  font-weight: normal;
  font-size: 140%;
}
#blocklyDiv {
  float: right;
  height: 95%;
  width: 70%;
}
#importExport {
  font-family: monospace;
}
</style>
</head>
<body onload="start()">

  <div id="blocklyDiv"></div>

  <xml id="blocklyDefault">
  </xml>

  <xml id="toolbox" style="display: none">
    <category name="Music" colour="20">
      <block type="music_play_note"></block>
      <block type="music_play_note_with_duration"></block>
      <block type="music_play_chord"></block>
    </category>

    <category name="Loops" colour="120">
      <block type="controls_repeat">
        <value name="TIMES">
          <shadow type="math_number">
            <field name="NUM">10</field>
          </shadow>
        </value>
      </block>
      <block type="controls_forEach"></block>
    </category>

    <sep></sep>

    <category name="Functions" colour="290" custom="PROCEDURE">
    </category>

    <category name="Logic" colour="210">
      <block type="controls_if"></block>
      <block type="logic_compare"></block>
      <block type="logic_operation"></block>
      <block type="logic_negate"></block>
      <block type="logic_boolean"></block>
      <block type="logic_ternary"></block>
    </category>
  </xml>

  <h1>Blockly Music Demo</h1>

  <p>
    <strong>Tutorial:</strong>
    <a href="#" onclick="setChallenge('tutorial', 1); return false;">1</a>
    <a href="#" onclick="setChallenge('tutorial', 2); return false;">2</a>
    <a href="#" onclick="setChallenge('tutorial', 3); return false;">3</a>
    <a href="#" onclick="setChallenge('tutorial', 4); return false;">4</a>
    <a href="#" onclick="setChallenge('tutorial', 5); return false;">5</a>

    <strong>Beginner:</strong>
    <a href="#" onclick="setChallenge('beginner', 1); return false;">1</a>
    <a href="#" onclick="setChallenge('beginner', 2); return false;">2</a>
    <a href="#" onclick="setChallenge('beginner', 3); return false;">3</a>
    <a href="#" onclick="setChallenge('beginner', 4); return false;">4</a>
    <a href="#" onclick="setChallenge('beginner', 5); return false;">5</a>
    <a href="#" onclick="setChallenge('beginner', 6); return false;">6</a>
    <a href="#" onclick="setChallenge('beginner', 7); return false;">7</a>
    <a href="#" onclick="setChallenge('beginner', 8); return false;">8</a>
    <a href="#" onclick="setChallenge('beginner', 9); return false;">9</a>
    <a href="#" onclick="setChallenge('beginner', 10); return false;">10</a>
  </p>

  <p>
    <div id="instructions">
    </div>
  </p>

  <p>
    <input type="button" value="Run" onclick="playAndGrade();">
    <input type="button" id="playWithAccompanimentButton" value="Run with accompaniment" onclick="playWithAccompanimentAndGrade();">
    <span id="grade"></span>
  </p>

  <p>
    <input type="button" value="View JavaScript code" onclick="toCode('JavaScript')">
    <br><br>
    <textarea id="importExport" style="width: 26%; height: 12em"></textarea>
  </p>
</body>
</html>
