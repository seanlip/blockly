<!DOCTYPE html>
<html ng-app="abMusicDemo">
  <head>
    <meta charset="utf-8">
    <title>Blockly Music demo</title>
    <script src="../../blockly_uncompressed.js"></script>
    <script src="../../generators/javascript.js"></script>
    <script src="../../generators/javascript/music.js"></script>
    <script src="../../generators/javascript/loops.js"></script>
    <script src="../../generators/javascript/procedures.js"></script>
    <script src="../../generators/javascript/logic.js"></script>
    <script src="../../msg/messages.js"></script>
    <script src="../../blocks/music.js"></script>
    <script src="../../blocks/loops.js"></script>
    <script src="../../blocks/procedures.js"></script>
    <script src="../../blocks/logic.js"></script>

    <!-- Libraries for Angular and MIDI.js. -->
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.5/angular.js"></script>
    <script src="../../../MIDI.js/build/MIDI.js"></script>
    <script src="../../../MIDI.js/inc/shim/Base64binary.js"></script>

    <!-- Libraries for music demo. -->
    <script src="./index.js"></script>
    <script src="./music_player.js"></script>
    <script src="./levels.js"></script>

    <script>
      'use strict';

      // Depending on the URL argument, render as LTR or RTL.
      var rtl = (document.location.search == '?rtl');
      var workspace = null;
      var musicPlayer = null;

      function start() {
        var toolbox = document.getElementById('toolbox');
        workspace = Blockly.inject('blocklyDiv', {
          collapse: true,
          comments: true,
          disable: true,
          grid: {
            colour: '#ccc',
            length: 3,
            snap: true,
            spacing: 25
          },
          maxBlocks: Infinity,
          media: '../../media/',
          readOnly: false,
          rtl: rtl,
          scrollbars: true,
          toolbox: toolbox,
          zoom: {
            controls: true,
            maxScale: 4,
            minScale: .25,
            scaleSpeed: 1.1,
            startScale: 1.0,
            wheel: true
          }
        });

        // Decrease the hover time for tooltips.
        Blockly.Tooltip.HOVER_MS = 150;

        var defaultBlocks = document.getElementById('blocklyDefault');
        Blockly.Xml.domToWorkspace(workspace, defaultBlocks);

        musicPlayer = new MusicPlayer();
      }

      // The code generated by the blocks calls this function.
      function addChord(pitches, durationInBeats) {
        musicPlayer.addPlayerChord(pitches, durationInBeats);
      }

      function toCode(lang) {
        var output = document.getElementById('importExport');
        output.value = Blockly[lang].workspaceToCode(workspace);
      }
    </script>

    <style>
      html, body {
        height: 100%;
      }
      body {
        background-color: #fff;
        font-family: sans-serif;
        overflow: hidden;
      }
      h1 {
        font-weight: normal;
        font-size: 140%;
      }
      #blocklyDiv {
        float: right;
        height: 95%;
        width: 70%;
      }
      #importExport {
        font-family: monospace;
      }

      .level-dot {
        border: 1px solid #ddd;
        border-radius: 50%;
        display: inline-block;
        font-size: 0.8em;
        height: 15px;
        text-align: center;
        text-decoration: none;
        width: 15px;
      }
      .level-dot-current {
        cursor: default;
      }
      .level-number {
        border: 1px solid #ddd;
        border-radius: 20px;
        padding: 6px 12px;
        color: #888;
      }
      .level-done, .level-dot:hover, .level-number:hover {
        background-color: #ddd;
        color: #000;
      }

      .level-set-selector {
        cursor: pointer;
      }
    </style>
  </head>

  <body onload="start()" ng-controller="Index">
    <table width="100%">
      <tbody>
        <tr>
          <td width="60%">
            <h1>
              Blockly Games: Music
              <span ng-repeat="level in currentLevels track by $index"
                    ng-class="{'level-dot-current': $index === currentLevelIndex}">
                <a ng-if="currentLevelIndex !== $index" href="#"
                   class="level-dot"
                   ng-class="{'level-number': ($index === currentLevelIndex) || $last}"
                   ng-click="setLevel($index)">
                  <span ng-if="$last">{{$index + 1}}</span>
                </a>
                <span ng-if="currentLevelIndex === $index"
                      class="level-dot level-number"
                      ng-class="{'level-number': $last}">
                  {{$index + 1}}
                </span>
              </span>

              &nbsp;&nbsp;
            </h1>
          </td>
          <td width="40%">
            Levels:
            <span ng-repeat="levelSet in levelSets track by $index">
              <a ng-if="currentLevelSetIndex !== $index"
                 ng-click="setLevelSet($index)"
                 class="level-set-selector">
                {{levelSet.name}}
              </a>
              <span ng-if="currentLevelSetIndex === $index">
                <strong>{{levelSet.name}}</strong>
              </span>
            </span>
          </td>
        </tr>
      </tbody>
    </table>

    <div id="blocklyDiv"></div>

    <xml id="blocklyDefault">
    </xml>

    <xml id="toolbox" style="display: none">
      <block type="music_play_note" ng-if="isBlockAvailable('music_play_note')"></block>
      <block type="music_play_note_with_duration"
             ng-if="isBlockAvailable('music_play_note_with_duration')"></block>
      <block type="music_play_chord" ng-if="isBlockAvailable('music_play_chord')"></block>
      <block type="controls_repeat" ng-if="isBlockAvailable('controls_repeat')">
        <value name="TIMES">
          <shadow type="math_number">
            <field name="NUM">10</field>
          </shadow>
        </value>
      </block>
      <block type="controls_forEach" ng-if="isBlockAvailable('controls_forEach')"></block>
    </xml>

    <p>
      <div>
        {{currentLevel.htmlInstructions}}
      </div>
    </p>

    <p>
      <input type="button" value="Run" ng-click="playAndGrade()">
      <input type="button" value="Run with accompaniment"
             ng-if="currentLevel.accompaniment"
             ng-click="playWithAccompanimentAndGrade()">
      <span>{{grade}}</span>
    </p>

    <p>
      <input type="button" value="View JavaScript code" onclick="toCode('JavaScript')">
      <br><br>
      <textarea id="importExport" style="width: 26%; height: 12em"></textarea>
    </p>
  </body>
</html>
